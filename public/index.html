<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>James41 - Bitter</title>
        <!-- MDL -->
        <link href="/css/material.min.css" rel="stylesheet">
        <script src="/js/material.min.js"></script>
        <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
        <!-- Bootstrap -->
        <link href="/css/bootstrap.min.css" rel="stylesheet">
        <!-- My CSS -->
        <link href="/bitter.css" rel="stylesheet">
        <style>
        body { padding-top: 80px; }
        </style>
    </head>
    <body>
        <div id="app"></div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="/js/jquery.min.js"></script>

        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="/js/bootstrap.min.js"></script>

        <!--<script src="https://npmcdn.com/react-router/umd/ReactRouter.min.js"></script>-->
        <script src="/bundle.js"></script>
        <script>
        /*$('.collapse-link').mouseup(function(){
            id = this.getAttribute('data-id');
            ref = this.getAttribute('href');
            active_change($(this),id,ref);
        }); */
        
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

        $('[bleat]').on('input', function () {
            var area = $("textarea",this);
            $("textarea",this).val($("textarea",this).val().replace(/\n/g,''));
            var count = $("textarea",this).val().length;
            if (count > 0) {
                $("button",this).attr("disabled",false);
            } else {
                $("button",this).attr("disabled","disabled");
            }
            $("span.help-block",this).text(count+'/142');
            // alert(">>"+count);
        })

        $('[bleat]').keypress(function(e) {
            if (e.which == 13) { // enter key
                this.submit()
            }
        })

        $('#new-user-required').keypress(function(e) {
            if (e.which == 13) { // enter key
                this.submit()
            }
        })

        $('form','div.panel-group').on('input', function () {
            $("button",this).attr("disabled",false);
        });

        // Prevent newlines in all textareas
        $('textarea').on('input', function () {
            $(this).val($(this).val().replace(/\n/g,''));
        })

        $('#edit-user-submit').click(function(){
            if (/^[A-Za-z\-]+( [A-Za-z\-]+)*$/.test($('input[name="edit-name"]').val())){
                $('input[name="edit-name"]').parent().removeClass('has-error');
                $('#name-help').text('');
                $(this).parent().submit()
            } else {
                $('input[name="edit-name"]').parent().addClass('has-error');
                $('#name-help').text('Full name required.');
            }
        })

        $('#change-email-submit').click(function(){
            var emailform = $(this).parent();
            $('input[name="change-email"]',emailform).val()
            if (/^[^@\s]+@[\w\-]+(\.[\w\-]+)+$/.test($('input[name="change-email"]',emailform).val())){
                $('input[name="change-email"]',emailform).parent().removeClass('has-error');
                $('span[class="help-block"]',emailform).text('');
                emailform.submit();
            } else {
                $('input[name="change-email"]',emailform).parent().addClass('has-error');
                $('span[class="help-block"]',emailform).text('Invalid email address.');
            }
        })
        
        $('#change-password-submit').click(function(){
            if ($('input[name="change-password"]').val() != $('input[name="change-password-confirm"]').val()){
                $('input[name="change-password"]').parent().addClass('has-error');
                $('input[name="change-password-confirm"]').parent().addClass('has-error');
                $('#password-help').text('Passwords do not match.');
            } else if ($('input[name="change-password"]').val() == '' && $('input[name="change-password-confirm"]').val() == ''){
                $('input[name="change-password"]').parent().addClass('has-error');
                $('input[name="change-password-confirm"]').parent().addClass('has-error');
                $('#password-help').text('Password is required.');
            } else {
                $('#password-help').text('');
                $(this).parent().submit();
            }
        })

        $('#new-user-submit').click(function() {
            $('div.form-group',$('#new-user-required')).each(function(i){
                if ($('input',this).val().length == 0){
                    $(this).addClass('has-error');
                } else {
                    $(this).removeClass('has-error');
                }
                if ($('input',this).attr("name") == 'email'){
                    if (/^[^@\s]+@[\w\-]+(\.[\w\-]+)+$/.test($('input[name="email"]',this).val())){
                        $(this).removeClass('has-error');
                        $('#email-help').text('');
                    } else {
                        $(this).addClass('has-error');
                        $('#email-help').text('Invalid email address.');
                    }
                } else if ($('input',this).attr("name") == 'full-name'){
                    if (/^[A-Za-z\-]+( [A-Za-z\-]+)*$/.test($('input[name="full-name"]',this).val())){
                        $(this).removeClass('has-error');
                        $('#name-help').text('');
                    } else {
                        $(this).addClass('has-error');
                        $('#name-help').text('Full name required.');
                    }
                } else if ($('input',this).attr("name") == 'new-username'){
                    if (/^\w+$/.test($('input[name="new-username"]',this).val())){
                        $(this).removeClass('has-error');
                        $('#username-help').text('');
                    } else {
                        $(this).addClass('has-error');
                        $('#username-help').text('Invalid username.');
                    }
                }
            });
            if ($('input[name="new-password"]').val() != $('input[name="new-password-confirm"]').val()){
                $('input[name="new-password"]').parent().addClass('has-error');
                $('input[name="new-password-confirm"]').parent().addClass('has-error');
                $('#password-help').text('Passwords do not match.');
                // alert('moo');
                // $("span.help-block",this).text(count+'/142');
            } else if ($('input[name="new-password"]').val() == '' && $('input[name="new-password-confirm"]').val() == ''){
                $('input[name="new-password"]').parent().addClass('has-error');
                $('input[name="new-password-confirm"]').parent().addClass('has-error');
                $('#password-help').text('Password is required.');
                // alert('oom');
            } else {
                $('#password-help').text('');
                // alert('foo');
            }
            var all_valid = 1;
            $('div.form-group',$('#new-user-required')).each(function(i){
                if ($(this).hasClass("has-error")){
                    all_valid = 0;
                }
            });
            if (all_valid){
                // alert('submit');
                // $('#new-user-required').submit();
                document.getElementById("new-user-required").submit();
            }
        });
        
        // remove error styling once edited
        $('div.form-group input').on('input', function () {
            // alert('af');
            $(this).parent().removeClass('has-error');
            if ($(this).attr('name') == 'new-password'){
                $('input[name="new-password-confirm"]').parent().removeClass('has-error');
            } else if ($(this).attr('name') == 'new-password-confirm'){
                $('input[name="new-password"]').parent().removeClass('has-error');
            }
            if ($(this).attr('name') == 'change-password'){
                $('input[name="change-password-confirm"]').parent().removeClass('has-error');
            } else if ($(this).attr('name') == 'change-password-confirm'){
                $('input[name="change-password"]').parent().removeClass('has-error');
            }
        });

        /* // limit names to alphabet
        $('input[name="full-name"]').on('input', function () {
            var area = $("textarea",this);
            $(this).val($(this).val().replace(/[^A-Za-z ]/g,''));
        });
        
        // limit usernames to word chars
        $('input[name="new-username"]').on('input', function () {
            var area = $("textarea",this);
            $(this).val($(this).val().replace(/\W/g,''));
        }); */

        $('[login]').on('input', function () {
            var username = $("input[type=text]",this).val().length;
            var password = $("input[type=password]",this).val().length;
            // var count = username.val().length + password.val().length
            if ((username > 0) && (password > 0)) {
                $("button",this).attr("disabled",false);
            } else {
                $("button",this).attr("disabled","disabled");
            }
            // $("span.help-block",this).text(count+'/142');
            // alert(">>"+count);
        })

        // if panel open, show associated button as active
        $('.collapse').on('show.bs.collapse', function () {
            var id = this.getAttribute('id');
            $('.btn[href="#'+id+'"').addClass('active');
        })
        
        // if panel closed, show associated button as inactive
        $('.collapse').on('hide.bs.collapse', function () {
            var id = this.getAttribute('id');
            $('.btn[href="#'+id+'"').removeClass('active');
        })

        // toggle hiding of toasts
        $('.toaster').click(function() {
            var alert = this.getAttribute('href');
            if ($(alert).hasClass('in')){
                $(alert).removeClass('in');
            } else {
                $(alert).addClass('in');
            }
        })

        $('#delete-bleat-dialog').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget)
            var bleat = button.data('bleat')
            $('button.btn-danger',this).val(bleat)
        });
        </script>
    </body>
</html>
